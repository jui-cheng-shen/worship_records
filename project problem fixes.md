# 聚會記錄系統問題修復報告

## 摘要
此報告彙整了 **「DALIN TJC RECORD」聚會記錄系統** 中發現的所有問題，並提供相應的解決方案。這些問題涵蓋了資料庫結構、功能實作、使用者介面、錯誤處理等各個方面。

---

## 主要問題與解決方案

### 1. 資料庫結構問題

#### 1.1 `remarks` 欄位定義錯誤
- **問題描述：**
  - 在建立資料表時，`total INTEGER` 與 `remarks TEXT DEFAULT ''` 之間缺少逗號。
  - 導致 `remarks` 欄位未被正確建立，引發：
    ```
    sqlite3.OperationalError: table count has no column named remarks
    ```
- **解決方案：**
  - 補上缺漏的逗號，正確建立 `remarks` 欄位。

---

### 2. 全域變數宣告問題

#### 2.1 重複宣告全域變數
- **問題描述：**
  - 在 `fill_revision_form` 和 `delete_record` 函數中重複宣告 `global current_record_id`
  - 導致：
    ```
    SyntaxError: name 'current_record_id' is used prior to global declaration
    ```
- **解決方案：**
  - 移除重複宣告或正確安排 `global` 宣告的位置。

---

### 3. 變數未定義問題

#### 3.1 `auto_fix_record` 函數中的 `correct_time_period` 未定義
- **問題描述：**
  - 當 `actual_meeting_type` 不符合預設條件時，`correct_time_period` 未被賦值。
  - 導致：
    ```
    UnboundLocalError: cannot access local variable 'correct_time_period'
    ```
- **解決方案：**
  - 為 `correct_time_period` 提供預設值或加上錯誤處理邏輯。

---

### 4. 同一天多場聚會處理問題

#### 4.1 同一天多場聚會的識別與處理
- **問題描述：**
  - 當同一天有多場聚會（如上午和下午）時，只用日期作為識別不足。
  - 導致載入、更新、刪除時可能操作錯誤場次。
- **解決方案：**
  - 實作選擇對話框，讓使用者選擇正確場次。
  - 改用記錄 `ID` 作為主要識別符。

---

### 5. UI 相關問題

#### 5.1 查詢結果數字欄位對齊
- **問題描述：** 數字欄位未對齊，難以閱讀。
- **解決方案：** 使用 `anchor="e"` 或樣式改善對齊方式。

#### 5.2 統計結果顯示優化
- **問題描述：** 顯示格式不整齊。
- **解決方案：** 統一欄寬與顯示格式。

#### 5.3 按鈕與鍵盤操作優化
- **問題描述：** 使用者無法用 Enter 鍵儲存。
- **解決方案：** 綁定按鈕動作至 Enter 鍵事件。

---

### 6. 功能擴展

#### 6.1 增加備註欄位
- **問題描述：** 需支援多行備註。
- **解決方案：** 新增 `remarks` 欄位並使用 `Text` 元件輸入。

#### 6.2 新增刪除功能
- **問題描述：** 無法刪除聚會記錄。
- **解決方案：** 加入刪除按鈕與確認機制。

---

### 7. 安息日聚會的「時間段」欄位無法正確記錄上午/下午

#### 7.1 問題現象
- 安息日聚會的「時間段」欄位無法正確記錄上午/下午。
  - 不論你在表單選擇上午還是下午，資料庫最後都可能只出現「下午」或「上午」，導致資料不一致。
- 舊資料修正後，資料庫欄位格式仍會錯亂。
  - 修正舊資料時，meeting_type、time_period、week 欄位內容有時會錯位或被覆蓋，造成查詢與顯示異常。

#### 7.2 問題原因
- `auto_fix_record` 函數的欄位修正邏輯有誤。
  - 原本的 `auto_fix_record` 會根據聚會類型自動推斷時間段（如安息日聚會預設下午），這會覆蓋使用者實際輸入的上午/下午。
  - 在修正舊資料時，time_period 欄位的來源有時是錯誤的（例如從 week 欄位取值），導致資料格式錯亂。

#### 7.3 Debug 過程
- **嘗試自動推斷時間段**  
  一開始讓 `auto_fix_record` 根據聚會類型自動設定上午/下午/晚上，結果發現這會覆蓋掉使用者輸入的時間段，尤其是安息日聚會永遠變成下午。
- **改為只修正欄位位置，不推斷內容**  
  將 `auto_fix_record` 改為只修正 meeting_type、time_period、week 三個欄位的位置，內容完全保留原本的值。這樣做後，使用者輸入的上午/下午可以正確保留，但如果舊資料本身欄位就錯位，還是會有資料格式錯亂的情況。
- **確認欄位來源**  
  檢查 record[2]、record[3]、record[4] 的內容，發現有時候 time_period 會從 week 欄位取值，這會造成資料不一致。最終調整為：只在 meeting_type 是星期時，將原本的 time_period（record[3]）當作聚會類別，將 week（record[4]）當作時間段（如果是上午/下午/晚上），否則保留原本的 time_period。
- **驗證修正效果**  
  經過上述調整後，發現只要表單輸入正確，資料庫就能正確記錄上午/下午/晚上，不會再被自動覆蓋。舊資料修正後，欄位也能對應正確，不會再亂掉。

#### 7.4 解決方案
- `auto_fix_record` 應只做欄位位置修正，不應推斷或覆蓋內容，這樣才能確保使用者輸入的資料被正確保存。
- 舊資料修正時要明確對應欄位來源，不要混用內容來源，避免資料格式錯亂。
- 測試時多用不同聚會類型與時間段組合，確保所有情境都能正確保存與查詢。

---

## 建議事項

### 🔒 錯誤處理與資料驗證
- 為所有輸入錯誤提供明確錯誤提示。
- 增加刪除操作確認。
- 前後端資料有效性檢查。
- 數字欄位加上合理範圍限制。
- 防止 SQL 注入攻擊。

### 🎨 UI/UX 改善
- 使用一致的顏色與樣式主題。
- 為按鈕加入圖示提升識別。
- 優化表單欄位排列順序與對齊。

### 🧠 程式碼優化
- 抽取共用函數，減少重複程式碼。
- 加入註解說明複雜邏輯。
- 改用具意義的變數與函式命名。

### 💾 備份與恢復
- 增加資料庫自動備份功能。
- 提供匯出/匯入功能，支援 CSV、Excel 格式。

---

## 結論

透過本報告列出的修復與優化方案，「DALIN TJC RECORD」聚會記錄系統的主要問題已獲改善。系統現在可正確處理同一天多場聚會，支援備註與刪除功能，並擁有更友善的操作介面。

建議持續依照「建議事項」進行優化，以進一步提升系統穩定性與使用者體驗。

---

📅 **報告日期：2025 年 6 月 24 日**
